Menu="NetworkServices"
Icon="openvpnclient.png"
Author="Peter_sm"
Version="2014.12.02"
Type="php"
Title="OpenVPN Client"
---
<?PHP
$logstring="";
$statuslogstring="";
$ext_running="";
$openvpn_cfg = parse_ini_file("/boot/config/plugins/openvpnclient/openvpnclient.cfg");
$openvpn_running_1 = shell_exec("/etc/rc.d/rc.openvpnclient check_alive");
$openvpn_running = trim($openvpn_running_1);
$runningpid = shell_exec("/etc/rc.d/rc.openvpnclient status");
$extend_vpn_ip = shell_exec("/etc/rc.d/rc.openvpnclient extended_IP");
$dev_tun = shell_exec("/etc/rc.d/rc.openvpnclient extended_device");
$check_netstat = shell_exec("ip route show");
$OPEN_VPN_ONLINE_VER = shell_exec("/etc/rc.d/rc.openvpnclient getonlineversion");
$OPEN_VPN_INSTALLED = shell_exec("/etc/rc.d/rc.openvpnclient getlocalversion");
$openvpn_myip = shell_exec("/etc/rc.d/rc.openvpnclient tunnel_IP");

if ($openvpn_cfg['PLG_EXT'] != "no") { $ext_running = "yes"; }

    if (file_exists('/tmp/openvpn/openvpn-status.log')) 
         {$statuslogstring = file_get_contents('/tmp/openvpn/openvpn-status.log');}

    if (file_exists('/tmp/openvpn/openvpn.out')) 
         {$logstring = file_get_contents('/tmp/openvpn/openvpn.out');}
            
    if (file_exists('/tmp/openvpn/openvpn.out.error'))
         {$logstring = file_get_contents('/tmp/openvpn/openvpn.out.error');}
?>

<HTML>
<HEAD></HEAD>
<BODY>

<div style="width: 45%; float:left">
 <div id="title">
    <span class="left">Status:&nbsp;<img src='/boot/config/plugins/openvpnclient/device_status.png'>
      <?if ($openvpn_running=="yes"):?>
        <span class="green"><b>OpenVPN Client is RUNNING</b></span>
      <?else:?>
        <span class="red"><b>OpenVPN Client is NOT RUNNING</b></span>
      <?endif;?>
    </span>
  </div>
 
<br></br>
  
<div style="border: 0px solid black;">
<table>
      <tr style="font-weight:bold; font-size: 8pt; color:#333333; background:#F0F0F0; text-shadow:0 1px 1px #FFFFFF;">
        <td style="text-align: left;">CONFIG FILE</td>
        <td style="text-align: left;">Connected</td>
        <td style="text-align: left;">WAN IP</td>
        <td style="text-align: left;">Interface</td>
        <td style="text-align: left;">Extended Routing IP</td>
      </tr>

        <tr style="font-weight:bold; background:#FFFFFF;">
      	<td style="text-align: left;">
        <span class="blue-text font-size: 6pt"><?=$openvpn_cfg['OVPNCHOOSE'];?></span>
        </td>

        <td style="text-align: left;">
			<?if ($openvpn_running=="yes"):?>
     			 <a target="_blank"><span class="green font-size: 8pt"><b>Yes</b></a></span>
			<?else:?>
   			   <a target="_blank"><span class="red font-size: 8pt"><b>No</b></a></b></span>
		    <?endif;?>	
        </td>

        <td style="text-align: left;">
        	<?if ($openvpn_running=="yes"):?>
				<span class="green-text font-size: 8pt"><?=$openvpn_myip?></span>
			<?else:?>
				<span class="red-text font-size: 8pt"><?=$openvpn_myip?></span>
         	<?endif;?>
        </td>
       
        <td style="text-align: left;">
			<?if ($openvpn_running=="yes"):?>
				<span class="green-text font-size: 8pt"><?=$dev_tun?></span>
			<?else:?>
				<span class="red-text"></span>
			<?endif;?>
        </td>       

        <td style="text-align: left;">
       		<?if ($openvpn_running=="yes"):?>
				<?if ($ext_running=="yes"):?>
					<span class="green-text font-size: 8pt"><?=$extend_vpn_ip?></span>
				<?else:?>   
					<span class="red-text font-size: 8pt">None</span>
				<?endif;?>
        	<?else:?>  
				<span class="red-text"> </span>
			<?endif;?>
        </td>
      </tr>
    </table>
           
</div> 

<br></br>

<div>
 <table>    
     <tr style="font-weight:bold; color:#333333; background:#F0F0F0; text-shadow:0 1px 1px #FFFFFF;">
     <td colspan="2" style="text-align: center;">Control Actions</td>
     </tr>   
          
     <?if ($openvpn_running=="yes"):?>
        <tr>
        <td width="30%">
        <form name="stop_openvpn" method="POST" action="/update.htm" target="progressFrame">
        <input type="hidden" name="cmd" value="/etc/rc.d/rc.openvpnclient stop">
        <input type="submit" name="runCmd" value="Stop">
        </form>
        </td>
        <td> <span class="green-text">Stop OpenVPN Client</span></td>
        </tr>
   
     <?else:?>
          </tr>
          <tr>
          <td width="30%">
          <form name="start_openvpn1" method="POST" action="/update.htm" target="progressFrame">
          <input type="hidden" name="cmd" value="/etc/rc.d/rc.openvpnclient start">
          <input type="submit" name="runCmd" value="start">
          </form>
          </td>
          <td> <span class="red-text">Start OpenVPN Client</span></td>
          </tr>
         
     <?endif;?>
    
    </table>
  </div>

<tr>
	<td><textarea class="tooltip" title="Information about the OpenVPN log is displayed in this area" wrap="hard" readonly="yes" style="width: 600px; height: 250px;color: blue;font-size: 8pt"><?php echo $logstring; ?></textarea></td>
        </tr>
	<br></br>
</div>

<div style="width: 49%; float:right; border: 0px solid black;">

  <div id="title">
    <span class="left">OpenVPN Client Configuration:&nbsp;<img src='/boot/config/plugins/openvpnclient/new_config.png'>
  </div>

  <br></br>

  <?if ($openvpn_running == "yes"):?>
    <div><center><b>To change configuration - Press Stop in "Control Action"</b></center></div>
  <?endif;?>

<br></br>

<div>
 <form name="openvpn_settings" method="POST" action="/plugins/openvpnclient/openvpnclient_submit.php" target="progressFrame" onsubmit="validateForm();">
 <table>
    <tr>
    <td colspan="2" align="left">
  	  <?if ($openvpn_running != "yes"):?>
        <input type="submit" value="Save Below Configuration">
      <?endif;?>
    </td>
    </tr>
        
<?if ($openvpn_running=="no"):?>
    <tr>
    <td>Use password to login ?</td>
	  <td>
	  <select name="PLG_PASSWORD" id="PLG_PASSWORD" class="tooltip" title="Enter No if the server you are connecting to does not require a username and password, if this is set to Yes, your OVPN file will be updated with your login credentials." size="1"> 
	  <?=mk_option($openvpn_cfg['PLG_PASSWORD']  , "no", "No");?>
		<?=mk_option($openvpn_cfg['PLG_PASSWORD']  , "yes", "Yes");?>
		</select>				
		</td>
		</tr>	  

		<tr>
  	<td>Client configuration file</td>
		<td>
		<select name="OVPNCHOOSE" id="OVPNCHOOSE" ">
			<?php
	 		?><option><?=$openvpn_cfg['OVPNCHOOSE'];?></option><?
	  	$dirName = "/boot/openvpn/";      
	  	$dirs=array($dirName);
	   		while($dir=array_pop($dirs)){
	    		$handle=opendir($dir);
	      		while($file=readdir($handle)){
	       			if($file!='.' && $file!='..'){
	         			$pathfilename=$dir.'/'.$file;
	           			if(is_file($pathfilename)){
		     						$checkextension = pathinfo($file, PATHINFO_EXTENSION);	
			  						if($checkextension === "ovpn"){
											$pathfilename = str_replace('//', '/', $pathfilename);
				?><option><? echo "$pathfilename\n "; ?></option><?
	       		   			}
	           			}
	       			else{
	        			$dirs[]=$pathfilename;
	       			}
	      		}
	    		}
	   		}
		?>
		</select>
		</td>
		</tr>	

		<tr>
		<td>Username for OpenVPN Client:</td>
		<td><input type="text" style="width:30%" class="tooltip" title="Add your username for your VPN account here" name="USER" id="USER" value="<?=$openvpn_cfg['USER'];?>"></td>
		</tr>		 
		
		<tr>
		<td>Password for OpenVPN Client:</td>
		<td><input type="password" style="width:30%" class="tooltip" title="Add your password for your VPN account here" name="PASS" id="PASS" value="<?=$openvpn_cfg['PASS'];?>"></td>	 
	 	</tr>
	        
	 	<tr>
		<td>Start OpenVPN during array mounting:</td>
		<td>
		<select name="START_ON_MOUNT" id="START_ON_MOUNT" size="1">
		<?=mk_option($openvpn_cfg['START_ON_MOUNT'], "no", "No");?>
		<?=mk_option($openvpn_cfg['START_ON_MOUNT'], "yes", "Yes");?>
		</select>
		</td>         
		<tr>
		                
		<tr>
		<td>Extended Routing:</td>
		<td>
		<select style="width:50%" name="PLG_EXT" id="PLG_EXT" size="1">
		<?=mk_option($openvpn_cfg['PLG_EXT'], "no", "None");?>
		<?=mk_option($openvpn_cfg['PLG_EXT'], "Bypass", "Bypass IP addresses from tunnel");?>
		<?=mk_option($openvpn_cfg['PLG_EXT'], "Specific", "Route only specific IP addresses");?>
		</select>
		</td>
		</tr>
  <?endif;?>
 </table>
</div>

<div>
 	
<br></br>
    <div>   
     <tr>	   	
     <td><textarea class="tooltip" title="Information from 'ip route show'  is displayed here.." wrap="hard" readonly="yes" style="width: 570px; height: 130px;color: blue;font-size: 8pt"><?php echo $check_netstat; ?></textarea></td>
     </tr>
       	<td><textarea class="tooltip" title="Information about the OpenVPN status is displayed in this area" wrap="hard" readonly="yes" style="width: 570px; height: 130px;color: blue;font-size: 8pt"><?php echo $statuslogstring; ?></textarea></td>
     <br></br>
    </div>     
<br></br>

</body>
</form>
</div>

<script type="text/javascript">
function validateForm() {
  document.getElementById('USER').disabled = false;
  document.getElementById('PASS').disabled = false;
  document.getElementById('START_ON_MOUNT').disabled = false;
  document.getElementById('PLG_EXT=').disabled = false;
  document.getElementById('PLG_PASSWORD').disabled = false;
  document.getElementById('OVPNCHOOSE').disabled = false;
}

function checkRUNNING(form) {
  if ("<?=$openvpn_running?>" == "yes") {
  
    form.USER.disabled = true;
    form.PASS.disabled = true;
    form.START_ON_MOUNT.disabled = true;
    form.PLG_EXT.disabled = true; 
    form.PLG_PASSWORD.disabled = true;
    form.OVPNCHOOSE.disabled = true;
  }
}

</script>
</BODY>
</HTML>
